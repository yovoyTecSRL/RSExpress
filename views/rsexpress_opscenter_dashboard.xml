<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Acci√≥n del Dashboard OpsCenter -->
    <record id="action_rsexpress_opscenter" model="ir.actions.client">
        <field name="name">RSExpress OpsCenter</field>
        <field name="tag">rsexpress_opscenter_dashboard</field>
    </record>

    <!-- Template QWeb del Dashboard - OWL v2 Reactivo 100% - Sin acceso directo al DOM -->
    <template id="rsexpress_opscenter_dashboard_template" name="RSExpress OpsCenter Dashboard">
        <div class="oe_ops o_rsexpress_opscenter">
            
            <!-- BANNER DE ERROR (si hay) -->
            <t t-if="state.hasError">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>‚ö†Ô∏è Error de conexi√≥n:</strong>
                    <t t-esc="state.errorMessage"/>
                    <button type="button" class="btn btn-sm btn-warning ms-2" t-on-click="forceRefresh">
                        üîÑ Reintentar
                    </button>
                </div>
            </t>

            <!-- T√çTULO CON LOADING INDICATOR -->
            <div class="text-center mb24" style="margin-top:20px;">
                <h1 style="color:#875A7B;font-weight:bold;font-size:2.5em;">
                    üöÄ RSExpress OpsCenter
                    <t t-if="state.isLoading">
                        <span class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </span>
                    </t>
                </h1>
                <p style="color:#666;font-size:1.1em;margin-top:10px;">
                    Motor Cognitivo √ìrbix ‚Ä¢ Panel de Control en Tiempo Real
                </p>
                <small style="color:#999;">
                    √öltima actualizaci√≥n: <t t-esc="state.lastUpdate"/> ‚Ä¢ Auto-refresh cada 5 segundos
                </small>
            </div>

            <!-- KPIs EN TARJETAS (REACTIVOS) -->
            <div class="row mb32">

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #875A7B;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#875A7B;font-weight:bold;">
                                <t t-esc="state.kpiTotalOrders"/>
                            </div>
                            <div class="o_label text-muted">Pedidos Totales</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #F39C12;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#F39C12;font-weight:bold;">
                                <t t-esc="state.kpiActiveOrders"/>
                            </div>
                            <div class="o_label text-muted">Activos</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #27AE60;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#27AE60;font-weight:bold;">
                                <t t-esc="state.kpiAvailableDrivers"/>
                            </div>
                            <div class="o_label text-muted">Disponibles</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #E74C3C;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#E74C3C;font-weight:bold;">
                                <t t-esc="state.kpiBusyDrivers"/>
                            </div>
                            <div class="o_label text-muted">En Ruta</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #3498DB;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#3498DB;font-weight:bold;">
                                <t t-esc="state.kpiCompletedToday"/>
                            </div>
                            <div class="o_label text-muted">Entregas Hoy</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 o_ops_card">
                    <div class="card text-center" style="border-top:4px solid #95A5A6;">
                        <div class="card-body">
                            <div class="o_value" style="font-size:2.5em;color:#95A5A6;font-weight:bold;">
                                <t t-esc="state.kpiFailedToday"/>
                            </div>
                            <div class="o_label text-muted">Fallos Hoy</div>
                        </div>
                    </div>
                </div>

            </div>

            <hr/>

            <!-- TABLA DE PEDIDOS ACTIVOS (100% REACTIVA CON t-foreach) -->
            <h2 class="mb16" style="color:#875A7B;">
                <i class="fa fa-truck"></i> Pedidos Activos
            </h2>
            <div class="table-responsive mb32">
                <table class="table table-striped table-hover">
                    <thead style="background-color:#f8f9fa;">
                        <tr>
                            <th>Orden</th>
                            <th>Cliente</th>
                            <th>Tel√©fono</th>
                            <th>Recogida</th>
                            <th>Entrega</th>
                            <th>Estado</th>
                            <th>Veh√≠culo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Si no hay pedidos -->
                        <t t-if="!state.orders or state.orders.length === 0">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fa fa-inbox fa-2x mb-2"></i><br/>
                                    No hay pedidos activos en este momento
                                </td>
                            </tr>
                        </t>

                        <!-- Iterar pedidos reactivamente -->
                        <t t-foreach="state.orders" t-as="order" t-key="order.id">
                            <tr>
                                <td><strong><t t-esc="order.name"/></strong></td>
                                <td><t t-esc="order.customer_name"/></td>
                                <td><t t-esc="order.customer_phone"/></td>
                                <td><small><t t-esc="order.pickup"/></small></td>
                                <td><small><t t-esc="order.delivery"/></small></td>
                                <td>
                                    <span t-attf-class="badge {{ getStateBadgeClass(order.state_raw) }}">
                                        <t t-esc="order.state"/>
                                    </span>
                                </td>
                                <td><strong><t t-esc="order.vehicle"/></strong></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>

            <!-- TABLA DE CONDUCTORES Y VEH√çCULOS (100% REACTIVA CON t-foreach) -->
            <h2 class="mt32 mb16" style="color:#27AE60;">
                <i class="fa fa-users"></i> Conductores y Veh√≠culos
            </h2>
            <div class="table-responsive mb32">
                <table class="table table-striped table-hover">
                    <thead style="background-color:#f8f9fa;">
                        <tr>
                            <th>Veh√≠culo</th>
                            <th>Conductor</th>
                            <th>Estado</th>
                            <th>√öltima Ubicaci√≥n GPS</th>
                            <th>√öltimo Ping</th>
                            <th>Entrega Activa</th>
                            <th>KM Hoy</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Si no hay veh√≠culos -->
                        <t t-if="!state.vehicles or state.vehicles.length === 0">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fa fa-car fa-2x mb-2"></i><br/>
                                    No hay veh√≠culos registrados
                                </td>
                            </tr>
                        </t>

                        <!-- Iterar veh√≠culos reactivamente -->
                        <t t-foreach="state.vehicles" t-as="vehicle" t-key="vehicle.id">
                            <t t-set="badge" t-value="getVehicleStatusBadge(vehicle.state)"/>
                            <tr>
                                <td><strong><t t-esc="vehicle.vehicle_name"/></strong></td>
                                <td><t t-esc="vehicle.driver_name"/></td>
                                <td>
                                    <span t-attf-class="badge {{ badge.class }}">
                                        <t t-esc="badge.icon"/> <t t-esc="badge.text"/>
                                    </span>
                                </td>
                                <td><small><t t-esc="formatGPS(vehicle.last_lat, vehicle.last_lon)"/></small></td>
                                <td><small><t t-esc="vehicle.last_gps_ping"/></small></td>
                                <td><small><t t-esc="vehicle.active_delivery"/></small></td>
                                <td><small><t t-esc="formatDistance(vehicle.distance_today)"/></small></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>

            <!-- MAPA ESTILO UBER -->
            <h2 class="mt32 mb16" style="color:#3498DB;">
                <i class="fa fa-map-marker"></i> Tracking en Tiempo Real
            </h2>
            <div id="rsexpress_map" style="height:400px;border-radius:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;">
                <div class="text-center" style="color:white;">
                    <i class="fa fa-map fa-5x mb-3" style="opacity:0.8;"></i>
                    <h3>Integraci√≥n Traccar GPS</h3>
                    <p style="font-size:1.1em;margin-top:10px;">
                        Mapa en tiempo real ‚Ä¢ Pr√≥ximamente con Leaflet + Traccar API
                    </p>
                    <small style="opacity:0.7;">
                        Los conductores aparecer√°n aqu√≠ con markers animados
                    </small>
                </div>
            </div>

        </div>
    </template>

</odoo>
