# ğŸ“š LÃ“GICA DEL MÃ“DULO RSEXPRESS - DOCUMENTACIÃ“N TÃ‰CNICA

## ğŸ¯ VISIÃ“N GENERAL

El mÃ³dulo **orbix_fleet_test** transforma los vehÃ­culos de Odoo Fleet en **agentes logÃ­sticos cognitivos** para RSExpress. Cada vehÃ­culo/mensajero tiene inteligencia operativa para gestionar entregas de forma autÃ³noma.

---

## ğŸ§  ARQUITECTURA DEL SISTEMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLEET.VEHICLE (BASE)                     â”‚
â”‚                          â¬‡ï¸ HEREDA                          â”‚
â”‚              FLEET.VEHICLE.RSEXPRESS (EXTENDIDO)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â¬‡ï¸                    â¬‡ï¸                    â¬‡ï¸
  CAMPOS NUEVOS         MÃ‰TODOS LÃ“GICOS       VISTAS MEJORADAS
  (15 campos)           (20+ mÃ©todos)         (Botones + KPIs)
```

---

## ğŸ“Š CAMPOS EXTENDIDOS (15 CAMPOS NUEVOS)

### 1ï¸âƒ£ **IDENTIFICADORES RSEXPRESS**

| Campo | Tipo | PropÃ³sito |
|-------|------|-----------|
| `x_internal_code` | Char | CÃ³digo Ãºnico del vehÃ­culo/mensajero (ej: "MOTO-001") |
| `x_qr_delivery_tag` | Char | CÃ³digo QR para escanear y asignar entregas rÃ¡pidamente |

**Uso:**
```python
vehicle = self.env['fleet.vehicle'].search([('x_internal_code', '=', 'MOTO-001')])
```

---

### 2ï¸âƒ£ **ESTADOS OPERATIVOS (WORKFLOW)**

| Campo | Tipo | Valores Posibles |
|-------|------|------------------|
| `x_operational_status` | Selection | 9 estados del ciclo logÃ­stico |

**Estados del Workflow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  available   â”‚ â† Estado inicial (vehÃ­culo libre)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   assigned   â”‚ â† Se le asignÃ³ una orden
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   on_route   â”‚ â† Va hacia el punto de recogida
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    picked    â”‚ â† RecogiÃ³ el paquete
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  delivering  â”‚ â† En camino hacia el cliente
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  delivered_ok    â”‚ delivered_issue  â”‚   failed    â”‚
â”‚  (Ã‰xito)         â”‚  (Con problemas) â”‚  (FallÃ³)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â¬‡ï¸                    â¬‡ï¸                â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  available   â”‚    â”‚  available   â”‚   â”‚  available   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TambiÃ©n existe:**
- `cancelled` â†’ Entrega cancelada

---

### 3ï¸âƒ£ **KPIs DE RENDIMIENTO**

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `x_orders_completed` | Integer | Total de entregas exitosas |
| `x_orders_failed` | Integer | Total de entregas fallidas |
| `x_success_rate` | Float (%) | Tasa de Ã©xito automÃ¡tica |
| `x_rating_score` | Float | CalificaciÃ³n promedio del mensajero |
| `x_total_km` | Float | KilÃ³metros totales histÃ³ricos |

**CÃ¡lculo automÃ¡tico:**
```python
x_success_rate = (x_orders_completed / (x_orders_completed + x_orders_failed)) * 100
```

---

### 4ï¸âƒ£ **TRACKING GPS EN TIEMPO REAL**

| Campo | Tipo | PropÃ³sito |
|-------|------|-----------|
| `x_last_gps_ping` | Datetime | Ãšltima actualizaciÃ³n GPS |
| `x_last_latitude` | Float | Ãšltima latitud |
| `x_last_longitude` | Float | Ãšltima longitud |
| `x_distance_today` | Float | KilÃ³metros del dÃ­a actual |

**FÃ³rmula Haversine para calcular distancia:**
```python
def _haversine_distance(self, lat1, lon1, lat2, lon2):
    R = 6371  # Radio de la Tierra en km
    dlat = radians(lat2 - lat1)
    dlon = radians(lon2 - lon1)
    a = sin(dlat/2)**2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    return R * c
```

---

### 5ï¸âƒ£ **RELACIONES CON EMPLEADOS**

| Campo | Tipo | RelaciÃ³n |
|-------|------|----------|
| `x_driver_id` | Many2one | Mensajero actual â†’ `hr.employee` |
| `x_next_driver_id` | Many2one | Mensajero programado para despuÃ©s |

---

### 6ï¸âƒ£ **RELACIONES CON Ã“RDENES (FUTURO)**

| Campo | Tipo | RelaciÃ³n |
|-------|------|----------|
| `x_active_delivery_id` | Many2one | Orden activa â†’ `delivery.order` |
| `x_assigned_deliveries_ids` | One2many | Historial de Ã³rdenes |

**Nota:** El modelo `delivery.order` aÃºn no existe, estÃ¡ preparado para integrarlo despuÃ©s.

---

## ğŸ”§ MÃ‰TODOS PYTHON (LÃ“GICA DE NEGOCIO)

### ğŸŸ¢ **MÃ‰TODOS DE CAMBIO DE ESTADO**

Cada mÃ©todo cambia el estado operativo y registra en el chatter.

#### 1. `action_set_available()`
```python
def action_set_available(self):
    self.x_operational_status = 'available'
    self.message_post(body="ğŸŸ¢ VehÃ­culo disponible para asignaciÃ³n")
```

#### 2. `action_set_assigned()`
```python
def action_set_assigned(self):
    if self.x_operational_status != 'available':
        raise ValidationError("Solo vehÃ­culos disponibles pueden ser asignados")
    self.x_operational_status = 'assigned'
    self.message_post(body="ğŸ“‹ Orden asignada al vehÃ­culo")
```

#### 3. `action_set_on_route()`
```python
def action_set_on_route(self):
    self.x_operational_status = 'on_route'
    self.message_post(body="ğŸš€ En ruta hacia punto de recogida")
```

#### 4. `action_set_picked()`
```python
def action_set_picked(self):
    self.x_operational_status = 'picked'
    self.message_post(body="ğŸ“¦ Paquete recogido exitosamente")
```

#### 5. `action_set_delivering()`
```python
def action_set_delivering(self):
    self.x_operational_status = 'delivering'
    self.message_post(body="ğŸšš En camino de entrega al cliente")
```

#### 6. `action_set_delivered_ok()`
```python
def action_set_delivered_ok(self):
    self.x_operational_status = 'delivered_ok'
    self.x_orders_completed += 1
    self._compute_success_rate()
    self.message_post(body="âœ… Entrega completada exitosamente")
    self.action_set_available()  # Auto-regreso a disponible
```

#### 7. `action_set_delivered_issue()`
```python
def action_set_delivered_issue(self):
    self.x_operational_status = 'delivered_issue'
    self.x_orders_completed += 1
    self.message_post(body="âš ï¸ Entrega con incidencias")
    self.action_set_available()
```

#### 8. `action_set_failed()`
```python
def action_set_failed(self):
    self.x_operational_status = 'failed'
    self.x_orders_failed += 1
    self._compute_success_rate()
    self.message_post(body="âŒ Intento de entrega fallido")
    self.action_set_available()
```

#### 9. `action_set_cancelled()`
```python
def action_set_cancelled(self):
    self.x_operational_status = 'cancelled'
    self.message_post(body="ğŸš« Entrega cancelada")
    self.action_set_available()
```

---

### ğŸ“¦ **MÃ‰TODOS DE GESTIÃ“N DE Ã“RDENES**

#### 1. `assign_delivery(order_id)`
Asigna una orden al vehÃ­culo.
```python
def assign_delivery(self, order_id):
    if self.x_operational_status != 'available':
        raise ValidationError("El vehÃ­culo no estÃ¡ disponible")
    
    self.x_active_delivery_id = order_id
    self.action_set_assigned()
    self.notify_customer('order_assigned')
    return True
```

#### 2. `pickup_delivery()`
Confirma que recogiÃ³ el paquete.
```python
def pickup_delivery(self):
    if self.x_operational_status != 'on_route':
        raise ValidationError("Debe estar en ruta para recoger")
    
    self.action_set_picked()
    self.notify_customer('package_picked')
```

#### 3. `confirm_delivery(success=True)`
Marca la entrega como exitosa o con problemas.
```python
def confirm_delivery(self, success=True):
    if self.x_operational_status != 'delivering':
        raise ValidationError("Debe estar entregando")
    
    if success:
        self.action_set_delivered_ok()
        self.notify_customer('delivered_success')
    else:
        self.action_set_delivered_issue()
        self.notify_customer('delivered_issue')
```

#### 4. `fail_delivery()`
Marca la entrega como fallida.
```python
def fail_delivery(self):
    self.action_set_failed()
    self.notify_customer('delivery_failed')
```

---

### ğŸ“ **MÃ‰TODO DE TRACKING GPS**

#### `update_gps(lat, lon)`
Actualiza posiciÃ³n GPS y calcula distancia recorrida.

```python
def update_gps(self, lat, lon):
    # Si hay posiciÃ³n previa, calcula distancia
    if self.x_last_latitude and self.x_last_longitude:
        distance = self._haversine_distance(
            self.x_last_latitude, 
            self.x_last_longitude,
            lat, 
            lon
        )
        
        self.x_total_km += distance
        self.x_distance_today += distance
        
        # Registra en chatter si moviÃ³ mÃ¡s de 1 km
        if distance > 1.0:
            self.message_post(
                body=f"ğŸ“ Movimiento de {distance:.2f} km detectado"
            )
    
    # Actualiza posiciÃ³n
    self.x_last_latitude = lat
    self.x_last_longitude = lon
    self.x_last_gps_ping = fields.Datetime.now()
```

---

### ğŸ“² **MÃ‰TODO DE NOTIFICACIONES**

#### `notify_customer(event)`
Registra evento (preparado para WhatsApp Respond.io).

```python
def notify_customer(self, event):
    events_map = {
        'order_assigned': 'Tu orden ha sido asignada',
        'package_picked': 'Paquete recogido',
        'delivered_success': 'Entrega exitosa',
        'delivered_issue': 'Entrega con incidencias',
        'delivery_failed': 'Intento fallido'
    }
    
    message = events_map.get(event, 'ActualizaciÃ³n de entrega')
    self.message_post(body=f"ğŸ“² NotificaciÃ³n: {message}")
```

---

### ğŸ”„ **MÃ‰TODO DE CICLO COMPLETO**

#### `complete_delivery_cycle()`
Ejecuta todo el ciclo de entrega automÃ¡ticamente (para testing).

```python
def complete_delivery_cycle(self):
    self.action_set_assigned()
    self.action_set_on_route()
    self.action_set_picked()
    self.action_set_delivering()
    self.action_set_delivered_ok()
```

---

### ğŸ• **CRON JOB - RESET DIARIO**

Resetea `x_distance_today` cada dÃ­a a las 00:00.

```python
def _cron_reset_daily_distance(self):
    vehicles = self.search([])
    vehicles.write({'x_distance_today': 0.0})
```

---

## ğŸ–¥ï¸ VISTAS E INTERFAZ

### 1ï¸âƒ£ **BOTONES DINÃMICOS EN FORMULARIO**

Archivo: `views/fleet_vehicle_rsexpress_buttons.xml`

**Header con statusbar:**
```xml
<header>
    <field name="x_operational_status" widget="statusbar"/>
    
    <button name="action_set_assigned" 
            string="Asignar Orden"
            invisible="x_operational_status != 'available'"/>
    
    <button name="action_set_on_route" 
            string="Iniciar Ruta"
            invisible="x_operational_status != 'assigned'"/>
    
    <!-- ... mÃ¡s botones ... -->
</header>
```

Los botones **aparecen y desaparecen** segÃºn el estado actual.

---

### 2ï¸âƒ£ **VISTA LISTA MEJORADA**

Archivo: `views/orbix_fleet_list_view.xml`

**Columnas nuevas:**
- CÃ³digo RSExpress
- Estado Operativo (con badges de color)
- Mensajero asignado
- Ã“rdenes completadas
- Tasa de Ã©xito (%)
- KM del dÃ­a
- Ãšltimo GPS

**Decoraciones por color:**
```xml
<tree decoration-success="x_operational_status == 'available'"
      decoration-info="x_operational_status in ['assigned', 'on_route']"
      decoration-warning="x_operational_status in ['picked', 'delivering']"
      decoration-danger="x_operational_status == 'failed'">
```

---

### 3ï¸âƒ£ **VISTA KANBAN**

Archivo: `views/fleet_vehicle_rsexpress_kanban.xml`

Muestra tarjetas con:
- Estado operativo
- KPIs principales
- Ãšltima ubicaciÃ³n GPS

---

## ğŸ” SEGURIDAD

Archivo: `security/ir.model.access.csv`

**Permisos:**
- `fleet_vehicle_user` â†’ Lectura para usuarios
- `fleet_vehicle_manager` â†’ Escritura/eliminaciÃ³n para managers

---

## ğŸš€ FLUJO OPERATIVO COMPLETO

```
1. Usuario crea vehÃ­culo â†’ Estado: available
2. Manager asigna orden â†’ assign_delivery() â†’ Estado: assigned
3. Mensajero inicia ruta â†’ action_set_on_route() â†’ Estado: on_route
4. Mensajero recoge paquete â†’ pickup_delivery() â†’ Estado: picked
5. Mensajero sale a entregar â†’ action_set_delivering() â†’ Estado: delivering
6. GPS actualiza posiciÃ³n â†’ update_gps(lat, lon) â†’ Calcula distancia
7. Mensajero entrega â†’ confirm_delivery(True) â†’ Estado: delivered_ok
8. KPIs se actualizan automÃ¡ticamente â†’ x_orders_completed += 1
9. Vuelve a disponible â†’ Estado: available
```

---

## ğŸ“Š EJEMPLO DE USO EN PYTHON

```python
# Obtener vehÃ­culo
vehicle = self.env['fleet.vehicle'].browse(1)

# Asignar orden
vehicle.assign_delivery(order_id=42)

# Actualizar GPS
vehicle.update_gps(lat=9.9281, lon=-84.0907)

# Confirmar recogida
vehicle.pickup_delivery()

# Confirmar entrega exitosa
vehicle.confirm_delivery(success=True)

# Ver KPIs
print(f"Tasa de Ã©xito: {vehicle.x_success_rate}%")
print(f"Total km: {vehicle.x_total_km} km")
```

---

## ğŸ¯ PRÃ“XIMOS PASOS

1. **Crear modelo `delivery.order`** para gestionar Ã³rdenes reales
2. **Integrar WhatsApp Respond.io** en `notify_customer()`
3. **Dashboard de anÃ¡lisis** con grÃ¡ficos de rendimiento
4. **Mapa en tiempo real** con posiciones GPS
5. **Alertas automÃ¡ticas** por fallos o demoras

---

## ğŸ“ SOPORTE

Para dudas tÃ©cnicas: Contactar al equipo de Sistemas Ã“rbix

---

**ğŸ§  RSExpress Logistics - Motor Cognitivo Ã“rbix**